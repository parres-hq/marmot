# MIP-02

## Nostr Group Data Extension

`draft` `mandatory`

### Overview

The Nostr Group Data Extension is a custom [MLS extension](https://datatracker.ietf.org/doc/draft-ietf-mls-extensions/) that associates Nostr-specific metadata with an MLS group in a cryptographically secure and proveable way. This extension enables seamless integration between the MLS protocol's end-to-end encryption capabilities and Nostr's decentralized identity and relay infrastructure.

This extension MUST be included as a required capability when creating a new group and MUST be supported by all group members. The extension data is part of the MLS group context and is authenticated and integrity-protected by the MLS protocol's cryptographic mechanisms.

### Extension Identifier

This extension uses the identifier `0xF2EE`. Implementations MUST use this identifier when registering support for this extension in MLS capabilities negotiation.

### Purpose and Use Cases

The Nostr Group Data Extension serves several critical functions:

1. **Group Identity Mapping**: Links MLS group encryption with Nostr's decentralized identity system
2. **Relay Agreement**: Provides authenticated relay endpoints for group message distribution
3. **Access Control**: Establishes cryptographically verified admin roles independent of MLS protocol roles
4. **Group Image Encryption**: Enables secure, encrypted media sharing within groups
5. **Metadata Protection**: Ensures group metadata changes are authenticated and verifiable by all members

### TLS Serialization Requirements

**CRITICAL IMPLEMENTATION NOTE**: This extension MUST be serialized using TLS presentation language as defined in [RFC 8446 Section 3](https://www.rfc-editor.org/rfc/rfc8446.html#section-3). All fields described below represent the logical structure - implementers MUST ensure their extension struct or object produces valid TLS wire format.

The extension data MUST be serializable as a TLS struct with proper length prefixes, type annotations, and byte alignment as required by the TLS presentation language specification. Failure to properly implement TLS serialization will result in interoperability failures between different MLS implementations.

### Extension Fields

The extension contains the following fields, each with specific validation requirements and constraints. When implementing TLS serialization, each field MUST be properly encoded according to its type specification.

#### Field Specifications

| Field            | TLS Type                                | Length Constraints | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------- | --------------------------------------- | ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nostr_group_id` | `opaque nostr_group_id[32]`            | Exactly 32 bytes   | A 32-byte identifier for the group used in Nostr protocol operations. This value is distinct from the MLS group ID and MAY be updated over time through group proposals. This identifier is used in the `h` tags when publishing group message events to Nostr relays. MUST be cryptographically random when initially generated.                                                                                                                                                                                                              |
| `name`           | `opaque name<0..2^16-1>`               | 0-65535 bytes      | UTF-8 encoded group name. MUST be valid UTF-8. SHOULD be limited to 255 characters for practical display purposes. Empty string is permitted for unnamed groups.                                                                                                                                                                                                                                                                                                                                                                               |
| `description`    | `opaque description<0..2^16-1>`        | 0-65535 bytes      | UTF-8 encoded group description. MUST be valid UTF-8. SHOULD be limited to 1000 characters for practical display purposes. Empty string is permitted.                                                                                                                                                                                                                                                                                                                                                                                          |
| `admin_pubkeys`  | `opaque admin_pubkeys<0..2^16-1>`      | 0-65535 bytes      | Array of 32-byte Nostr public keys (hex-encoded as 64-character strings, then UTF-8 encoded). Each public key MUST be a valid secp256k1 public key. Clients MUST verify admin status before processing proposals that modify group state, membership, or metadata. The array MUST NOT contain duplicate keys. At least one admin key MUST be present for most group operations.                                                                                                                                                                   |
| `relays`         | `opaque relays<0..2^16-1>`             | 0-65535 bytes      | Array of UTF-8 encoded WebSocket URLs for Nostr relays. Each URL MUST be a valid WebSocket URI (ws:// or wss://). URLs MUST be properly validated before use. The array SHOULD contain at least one relay URL and SHOULD NOT exceed 20 relays for practical performance.                                                                                                                                                                                                                                                                    |
| `image_hash`     | `opaque image_hash[32]`                | Exactly 32 bytes   | SHA-256 hash identifying the group's display image stored via [Blossom](https://github.com/hzrd149/blossom/tree/master) protocol. The hash MUST correspond to the actual image content for integrity verification. May be all zeros if no image is set.                                                                                                                                                                                                                                                                                      |
| `image_key`      | `opaque image_key[32]`                 | Exactly 32 bytes   | AES-256-GCM encryption key for the group's image. MUST be cryptographically random. Used in conjunction with `image_nonce` for authenticated encryption. May be all zeros if no image encryption is needed.                                                                                                                                                                                                                                                                                                                                   |
| `image_nonce`    | `opaque image_nonce[12]`               | Exactly 12 bytes   | AES-256-GCM nonce for image encryption. MUST be unique for each encrypted image. Used with `image_key` for authenticated encryption/decryption operations. May be all zeros if no image encryption is needed.                                                                                                                                                                                                                                                                                                                                  |

#### TLS Structure Definition

In TLS presentation language, the extension data MUST be structured as:

```tls
struct {
    opaque nostr_group_id[32];
    opaque name<0..2^16-1>;
    opaque description<0..2^16-1>;
    opaque admin_pubkeys<0..2^16-1>;
    opaque relays<0..2^16-1>;
    opaque image_hash[32];
    opaque image_key[32];
    opaque image_nonce[12];
} NostrGroupData;
```

#### Field Validation Requirements

**Nostr Group ID**:
- MUST be exactly 32 bytes
- SHOULD be cryptographically random when first generated
- MAY be changed through authenticated group proposals
- Used as the group identifier in Nostr protocol operations

**Name and Description**:
- MUST be valid UTF-8 encoded strings
- Length-prefixed as per TLS variable-length encoding
- Empty strings are permitted
- Implementations SHOULD enforce reasonable display limits

**Admin Public Keys**:
- Array of hex-encoded nostr public keys
- Each key MUST be exactly 64 hex characters (32 bytes encoded)
- Array encoding MUST follow TLS variable-length array rules
- Duplicate keys MUST be rejected
- At least one admin key SHOULD be present for group management

**Relays**:
- Array of WebSocket URL strings
- Each URL MUST be valid ws:// or wss:// URI
- Array encoding MUST follow TLS variable-length array rules
- Implementations SHOULD validate URL format before use

**Image Fields**:
- All image-related fields are fixed-length byte arrays
- Zero values indicate no image is configured
- When set, all three fields MUST be used together for proper encryption

### Implementation Considerations

#### TLS Serialization Examples

Implementers MUST ensure proper TLS serialization. Here are key considerations for each field type:

**Fixed-Length Fields** (`nostr_group_id`, `image_hash`, `image_key`, `image_nonce`):
```
// Raw bytes, no length prefix needed
byte[32] nostr_group_id = [0x1a, 0x2b, 0x3c, ...]; // 32 bytes exactly
byte[32] image_hash = [0x4d, 0x5e, 0x6f, ...];     // 32 bytes exactly
byte[32] image_key = [0x7a, 0x8b, 0x9c, ...];      // 32 bytes exactly
byte[12] image_nonce = [0xad, 0xbe, 0xcf, ...];    // 12 bytes exactly
```

**Variable-Length Fields** (`name`, `description`, `admin_pubkeys`, `relays`):
```
// TLS variable-length encoding with 2-byte length prefix
uint16 name_length = 11;
opaque name[name_length] = "Test Group"; // UTF-8 encoded

uint16 admin_pubkeys_length = 128; // 2 * 64-char hex strings
opaque admin_pubkeys[admin_pubkeys_length] = "03a1b2c3...64chars,02d4e5f6...64chars";

uint16 relays_length = 45;
opaque relays[relays_length] = "wss://relay1.com,wss://relay2.com";
```

#### Array Encoding Specifications

**Admin Public Keys Array**:
The `admin_pubkeys` field contains a comma-separated list of hex-encoded public keys:
- Each public key: 64 hex characters (representing 32 bytes)
- Separator: single comma character (',')
- No spaces around commas
- Example: `"03a1b2c3d4e5f6...,02f6e5d4c3b2a1..."`

**Relays Array**:
The `relays` field contains a comma-separated list of WebSocket URLs:
- Each URL: valid WebSocket URI (ws:// or wss://)
- Separator: single comma character (',')
- No spaces around commas
- Example: `"wss://relay1.example.com,wss://relay2.example.com"`

#### Extension Lifecycle Management

**Creation**: When creating a new group, this extension MUST be populated with initial values and included in the group's required capabilities.

**Updates**: Any field in this extension can be updated through MLS Proposal/Commit mechanisms. However, certain operations require admin authorization:

- **Admin-Only Operations**: Modifying `admin_pubkeys`, `name`, `description`, `relays`, or image fields
- **Self-Service Operations**: None - all extension updates require admin approval
- **Validation**: Before processing any Commit that modifies this extension, implementations MUST verify the committer is listed in the current `admin_pubkeys` array

#### Interoperability Guidelines

**MLS Library Integration**:
1. Register extension with identifier `0xF2EE` in your MLS library
2. Implement proper TLS serialization/deserialization for the `NostrGroupData` struct
3. Ensure extension is marked as "required" in group capabilities
4. Hook into MLS proposal processing to validate admin permissions

**Cross-Implementation Compatibility**:
- Always use the exact TLS structure definition provided
- Validate all UTF-8 strings for proper encoding
- Reject malformed public keys or invalid URLs
- Implement consistent array parsing (comma-separated, no spaces)

**Error Handling**:
- Invalid TLS serialization MUST result in proposal rejection
- Malformed UTF-8 strings MUST be rejected
- Invalid public keys or URLs MUST be rejected
- Admin permission violations MUST be rejected

#### Integration with MLS Protocol

This extension integrates with the MLS protocol at several points:

1. **Group Creation**: Extension data is included in the initial GroupContext
2. **Member Addition**: New members receive authenticated extension data via Welcome messages
3. **State Updates**: Extension modifications are proposed via Proposal messages and committed via Commit messages
4. **Authentication**: All extension data is authenticated by MLS's cryptographic mechanisms

The extension data is part of the MLS group's authenticated state, meaning any unauthorized modifications will be detected and rejected by the protocol's integrity checks.

All of these values can be updated over time using MLS `Proposal` and `Commit` events, subject to the admin authorization requirements specified above.
