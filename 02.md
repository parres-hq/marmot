# MIP-02

## Welcome Events

`draft` `mandatory`

This document defines Welcome Events (`kind: 444`) that enable secure group invitations in Marmot Protocol. Welcome Events provide everything new members need to join groups and start participating.

## Overview

Welcome Events are the mechanism for securely onboarding new members to MLS groups. When someone adds a new member to a group, they must send that person a Welcome Event containing all the cryptographic material needed to join and participate.

## Welcome Event Flow

### The Process

1. **Admin commits**: Group admin includes a new member via a `Commit` message
2. **Wait for confirmation**: Admin waits for relay acknowledgment of the Group Event
3. **Send Welcome**: Admin sends a private `Welcome` Event to the new member
4. **New member joins**: New member processes the Welcome and can start messaging

### Timing Requirements

Clients creating Welcome Events MUST:
1. **Wait for confirmation**: Don't send the Welcome until relays confirm receipt of the Commit
2. **Process before welcoming**: Ensure the group state change is committed before inviting

This sequencing prevents race conditions where a new member receives a Welcome for a group state that hasn't been finalized yet.

## Privacy and Security

### Gift-Wrapped Events

Welcome Events are sent as [NIP-59](https://github.com/nostr-protocol/nips/blob/master/59.md) gift-wrapped events to ensure:
- **Privacy**: Only the intended recipient can read the welcome
- **Unlinkability**: Observers can't tell who is being invited to what group
- **Deniability**: No public proof of group membership or invitation

### Security Considerations

Welcome Events contain sensitive cryptographic material that:
- **Enables group access**: Contains everything needed to decrypt group messages
- **Must be protected**: Should only be accessible to the intended recipient
- **Cannot be reused**: Each Welcome is specific to one member and one group state

## Welcome Event Structure

```json
{
  "id": "def456...",
  "kind": 444,
  "created_at": 1693876600,
  "pubkey": "02a1633cafe37eeebe2b39b4ec5f3d74c35e61fa7e7e6b7b8c5f7c4f3b2a1b2c3d",
  "content": "0987654321fedcba...",
  "tags": [
    ["e", "keypackage_event_id_123..."],
    ["relays", "wss://relay1.com", "wss://relay2.com"]
  ]
}
```

**Important**: This event is NOT signed (`"sig"` field omitted) to prevent accidental public publishing if it leaks.

### Field Details

**Required fields:**
- **`content`**: Hex-encoded serialized `MLSMessage` containing the MLS `Welcome` object
- **`e` tag**: ID of the KeyPackage Event used to add this user
- **`relays` tag**: List of relays where the new member should look for Group Events

**Security note**: The unsigned nature prevents the event from being accidentally published to public relays, as most relays reject unsigned events.

## Welcome Event Content

### MLS Welcome Object

The `content` field contains a hex-encoded MLS `Welcome` object that includes:

- **Group secrets**: Cryptographic keys needed to decrypt group messages
- **Group state**: Current member list and group configuration
- **Ratchet tree**: Key tree structure for the group
- **Extensions**: Group metadata including Nostr Group Data Extension

### Processing Requirements

When receiving a Welcome Event, clients MUST:

1. **Verify KeyPackage match**: Ensure the referenced KeyPackage belongs to this user
2. **Process MLS Welcome**: Use MLS library to process the Welcome and join the group
3. **Validate group state**: Verify all group extensions and configurations
4. **Store group information**: Save group keys, member list, and relay information
5. **Delete KeyPackage**: Remove the consumed KeyPackage from relays (if not last resort)

> #### Large Groups
>
> For groups above ~150 participants, welcome messages will become larger than is permitted by many Nostr relays. There is currently work underway on the MLS protocol to support "light" client `Welcome` objects that don't require the full Ratchet Tree state to be sent to the new member. This section will be updated with recommendations for how to handle large groups.

## Error Handling

### Welcome Processing Failures

If Welcome processing fails, clients SHOULD:

1. **Retain KeyPackage**: Do NOT delete the KeyPackage from relays
2. **Display clear errors**: Show user-friendly error messages
3. **Log technical details**: Capture technical information for debugging
4. **Retry mechanism**: Allow users to retry processing if appropriate

### Common Failure Scenarios

- **Signing key unavailable**: KeyPackage was created on a different device thus the secret key for the KeyPackage used to add the user to the group is not available.

## Summary

Welcome Events are the secure onboarding mechanism for Marmot groups:

### Key Components

1. **MLS Welcome Object**: Contains all cryptographic material for group access
2. **Gift-Wrapping**: Provides privacy and unlinkability using NIP-59
3. **KeyPackage Reference**: Links Welcome to the consuming KeyPackage
4. **Relay Information**: Tells new members where to find Group Events

### Security Features

- **Privacy protection**: Gift-wrapping hides invitation details
- **Unsigned events**: Prevents accidental public publishing
- **Timing guarantees**: Ensures group state consistency
- **Error resilience**: Graceful handling of processing failures

### Requirements for Implementers

**MUST implement**:
- NIP-59 gift-wrapping for all Welcome Events
- Proper timing (wait for Commit confirmation)
- KeyPackage lifecycle management
- Graceful error handling

**Security considerations**:
- Never sign Welcome Events
- Validate all KeyPackage references
- Protect group cryptographic material
- Handle large group limitations appropriately
