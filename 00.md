# MIP-00

## Credentials & Key Packages

`draft` `mandatory`

This document defines the credential management and KeyPackage system for Marmot Protocol. This is one of the core specifications that MUST be implemented by all projects wanting to be interoperable.

## Overview

The foundation for identity on Marmot is the Nostr network. Users are ultimately identified by their Nostr public/private keypairs. MLS Credentials prove a user's identity within groups, while KeyPackages advertise a user's ability to join groups. Together, they form the foundation of Marmot's identity and invitation system.

## MLS Credentials

### What are Credentials?

An MLS `Credential` proves a user's identity within the group and includes their signing key. Think of it as a secure ID card that also contains a key for signing messages.

### Identity Requirements

When creating credentials, clients MUST:

- **Use BasicCredential type**: The standard MLS credential format
- **Set identity to Nostr pubkey**: Use the 32-byte hex-encoded public key of the user's Nostr identity
- **Keep identity immutable**: Never allow changes to the identity field
- **Validate proposals**: Reject any `Proposal` or `Commit` that attempts to change identity fields

### Signing Keys

Each credential includes a signing key that:

- **Must be unique**: Different from the user's Nostr identity key
- **Signs MLS messages**: Used for all communications within the group
- **Should rotate regularly**: Improves security if a key is compromised
- **Starts in KeyPackage**: Initial signing key comes from the user's published KeyPackage event

> **Security Note**: Regular signing key rotation provides better forward-secrecy and post-compromise security, limiting the impact if a key is exposed.

## KeyPackage Events and Signing Keys

### What are KeyPackages?

A `KeyPackage` is like a public invitation card that tells others "you can add me to groups". Every user who wants to receive group invites MUST make at least one `KeyPackage` available to others, whether through publishing to Nostr relays, direct device-to-device sharing (Wi-Fi, Bluetooth, NFC), or other distribution methods.

### How KeyPackages Work

KeyPackages enable asynchronous group invitations by:

- **Advertising capabilities**: Shows what ciphersuites and extensions the user supports
- **Providing credentials**: Contains the user's MLS credential for authentication
- **Including signing keys**: Contains a unique signing key (different from Nostr identity key)
- **Supporting multiple configs**: Users can create multiple KeyPackages with different parameters

### KeyPackage Consumption and Reuse

**Normal usage**: A `KeyPackage` is "consumed" (used up) when someone joins a group with it.

**Race condition problem**: Multiple group invites might try to use the same KeyPackage simultaneously.

**Solution**: Use the "last resort" flag with the [`last_resort`](https://docs.rs/openmls/latest/openmls/extensions/struct.LastResortExtension.html) extension, which allows a KeyPackage to be reused when necessary.

### Key Management Requirements

Clients MUST:

- **Rotate signing keys quickly**: Change the signing key soon after joining via a last resort KeyPackage
- **Retain private keys**: Keep access to signing key private material for all groups
- **Manage KeyPackage lifecycle**: Automatically create and rotate KeyPackages

> **Security Note**: Quick signing key rotation after using a last resort KeyPackage maintains strong post-compromise security.

### Example KeyPackage Event

```json
{
  "id": "abc123...",
  "kind": 443,
  "created_at": 1693876543,
  "pubkey": "02a1633cafe37eeebe2b39b4ec5f3d74c35e61fa7e7e6b7b8c5f7c4f3b2a1b2c3d",
  "content": "0123456789abcdef...",
  "tags": [
    ["mls_protocol_version", "1.0"],
    ["ciphersuite", "0x0001"],
    ["extensions", "0x0001", "0x0002", "0x0003"],
    ["client", "MyMLSClient", "event123...", "wss://relay.example.com"],
    ["relays", "wss://relay1.com", "wss://relay2.com"],
    ["-"]
  ],
  "sig": "304502210..."
}
```

### Field Explanations

**Required fields:**
- **`content`**: Hex-encoded TLS-serialized `KeyPackageBundle` from your MLS implementation
- **`mls_protocol_version`**: MLS protocol version - currently `1.0`
- **`ciphersuite`**: MLS ciphersuite ID (see [MLS spec](https://www.rfc-editor.org/rfc/rfc9420.html#name-mls-cipher-suites))
- **`extensions`**: Array of supported MLS extension IDs (see [MLS spec](https://www.rfc-editor.org/rfc/rfc9420.html#name-extensions))
- **`relays`**: Relay URLs where this KeyPackage is published (needed for later deletion when using relay distribution)

**Optional fields:**
- **`client`**: Client info to help with UX when users can't access signing keys (may be omitted for privacy)
- **`-`**: Ensures only the author can publish this event (see [NIP-70](70.md))

### KeyPackage Lifecycle Management

#### When to Delete KeyPackages (relay-based distribution)

Clients SHOULD delete KeyPackages from relays when:

- **Successfully joining a group**: Delete the KeyPackage after processing a `Welcome` message
- **Creating new KeyPackages**: Optionally replace old ones with fresh KeyPackages

#### When NOT to Delete KeyPackages (relay-based distribution)

Clients MUST NOT delete KeyPackages when:

- **Welcome processing fails**: If you can't process a Welcome message (e.g., signing key generated on another device)
- **Show clear errors**: Display user-friendly error messages explaining the issue

> **Note**: For direct device-to-device KeyPackage sharing (Wi-Fi, Bluetooth, NFC), deletion considerations don't apply as the KeyPackage is transferred directly rather than stored on relays.

### Signing Key Rotation

#### Why Rotate Keys?

Regular signing key rotation strengthens security by:
- **Limiting compromise impact**: Reduces damage if a key is exposed
- **Improving forward secrecy**: Past messages remain secure even if current keys are compromised
- **Following MLS best practices**: Takes advantage of MLS's built-in security features

#### How to Rotate Keys

1. **Create Proposal**: Propose a key update for your leaf node
2. **Commit changes**: Include the proposal in a Commit message
3. **Broadcast to group**: Publish the Commit via a Group Event

Clients SHOULD rotate signing keys regularly in all groups they participate in.

> **Learn more**: See the [MLS RFC section on forward secrecy](https://www.rfc-editor.org/rfc/rfc9420.html#name-forward-secrecy-and-post-co) for deeper technical details.

### KeyPackage Relays List Event

When using relay-based KeyPackage distribution, users publish a `kind: 10051` event to advertise which relays contain their KeyPackages. This helps others know where to look for your KeyPackages when they want to invite you to groups.

#### Requirements (for relay-based distribution)

- **Include relay tags**: List all relays where you publish KeyPackages
- **Make them accessible**: These relays SHOULD be readable by anyone you want to receive invites from
- **Keep updated**: Update this list when you change your relay setup

#### Example Relays List Event

```json
{
  "kind": 10051,
  "tags": [
    ["relay", "wss://inbox.nostr.wine"],
    ["relay", "wss://myrelay.nostr1.com"]
  ],
  "content": "",
  "created_at": 1693876543,
  "pubkey": "02a1633cafe37eeebe2b39b4ec5f3d74c35e61fa7e7e6b7b8c5f7c4f3b2a1b2c3d",
  "sig": "304502210..."
}
```

## Summary

This MIP defines the foundation of Marmot's identity system:

### Key Components

1. **MLS Credentials**: Link Nostr identities to MLS signing keys
2. **KeyPackages** (`kind: 443`): Advertise your ability to join groups (via relays or direct sharing)
3. **Relay Lists** (`kind: 10051`): Where to find your KeyPackages (for relay-based distribution)
4. **Signing Key Rotation**: Regular key updates for enhanced security

### Security Requirements for Implementers

**MUST implement**:
- Proper credential management with Nostr identity keys
- KeyPackage lifecycle management (creation, deletion, rotation)
- Regular signing key rotation
- Last resort KeyPackage support

**Security considerations**:
- Keep signing keys separate from Nostr identity keys
- Rotate keys quickly after using last resort KeyPackages
- Validate all credential identity fields are immutable
- Properly manage KeyPackage private material across devices
