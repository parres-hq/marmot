# MIP-00

## Credentials & Key Packages

`review` `mandatory`

This document defines the credential management and KeyPackage system for Marmot Protocol. This is one of the core specifications that MUST be implemented by all projects wanting to be interoperable. Marmot identity builds on Nostr keypairs, with MLS Credentials proving group membership and KeyPackages enabling asynchronous invitations. This creates a secure bridge between Nostr's decentralized identity and MLS's group encryption.

## MLS Credentials

MLS `Credentials` link Nostr identities to group-specific signing keys, functioning as cryptographically secure membership proofs.

### Identity Requirements

When creating credentials, clients MUST:

- **Use BasicCredential type**: The standard MLS credential format
- **Set identity to Nostr pubkey**: Write the user's Nostr public key as exactly 32 raw bytes in the BasicCredential `identity` field. If your application stores keys as 64-character hex strings, decode the hex to bytes before serializing.
- **Keep identity immutable**: Never allow changes to the identity field
- **Validate proposals**: Reject any `Proposal` or `Commit` that attempts to change identity fields

> _Implementation note_: MLS encodes the BasicCredential identity as opaque bytes, so all implementations must emit the same 32-byte value. Comparing the raw bytes (not their hex representation) ensures credentials issued by different clients remain interoperable.

### Signing Keys

Each credential includes a unique signing key (distinct from Nostr identity) that signs MLS messages and should rotate regularly for enhanced security. The curve used for the signing key is determined by the [MLS ciphersuite](https://www.rfc-editor.org/rfc/rfc9420.html#section-17.1) used by the client. All MLS ciphersuites are supported and are signaled to other users via the `ciphersuite` tag in KeyPackage events.

## KeyPackage Events

KeyPackages function as public "invitation cards" enabling asynchronous group invitations. They advertise capabilities, provide credentials, and include signing keys for authentication. Users can publish them via Nostr relays or share directly between devices.

### KeyPackage Consumption and Reuse

KeyPackages are typically consumed when joining groups. To handle race conditions where multiple invites use the same KeyPackage, use the [`last_resort`](https://docs.rs/openmls/latest/openmls/extensions/struct.LastResortExtension.html) extension for reusability. Clients MUST rotate signing keys quickly after using last resort KeyPackages and retain private keys for all groups.

### Example KeyPackage Event

```json
{
  "id": "abc123...",
  "kind": 443,
  "created_at": 1693876543,
  "pubkey": "02a1633cafe37eeebe2b39b4ec5f3d74c35e61fa7e7e6b7b8c5f7c4f3b2a1b2c3d",
  "content": "0123456789abcdef...",
  "tags": [
    ["mls_protocol_version", "1.0"],
    ["ciphersuite", "0x0001"],
    ["extensions", "0x0001", "0x0002", "0x0003"],
    ["client", "MyMLSClient", "event123...", "wss://relay.example.com"],
    ["relays", "wss://relay1.com", "wss://relay2.com"],
    ["-"]
  ],
  "sig": "304502210..."
}
```

### Field Explanations

**Required fields:**
- **`content`**: Hex-encoded TLS-serialized `KeyPackageBundle` from your MLS implementation
- **`mls_protocol_version`**: MLS protocol version - currently `1.0`
- **`ciphersuite`**: MLS ciphersuite ID (see [MLS spec](https://www.rfc-editor.org/rfc/rfc9420.html#name-mls-cipher-suites))
- **`extensions`**: Array of supported MLS extension IDs (see [MLS spec](https://www.rfc-editor.org/rfc/rfc9420.html#name-extensions))
- **`relays`**: Relay URLs where this KeyPackage is published (needed for later deletion when using relay distribution)

**Optional fields:**
- **`client`**: Client info to help with UX when users can't access signing keys (may be omitted for privacy)
- **`-`**: Ensures only the author can publish this event (see [NIP-70](https://github.com/nostr-protocol/nips/blob/master/70.md))

### KeyPackage Lifecycle Management

#### When to Delete KeyPackages (relay-based distribution)

Clients SHOULD delete KeyPackages from relays when:

- **Successfully joining a group**: Delete the KeyPackage after processing a `Welcome` message
- **Creating new KeyPackages**: Optionally replace old ones with fresh KeyPackages

#### When NOT to Delete KeyPackages (relay-based distribution)

Clients MUST NOT delete KeyPackages when:

- **Welcome processing fails**: If you can't process a Welcome message (e.g., signing key generated on another device)
- **Show clear errors**: Display user-friendly error messages explaining the issue

> **Note**: For direct device-to-device KeyPackage sharing (QR code, Wi-Fi, Bluetooth, NFC), deletion considerations don't apply as the KeyPackage is transferred directly rather than stored on relays.

### Signing Key Rotation

All group members should regularly rotate their signing key within each group they are a part of on a regular basis. This limits compromise impact and improves forward secrecy per MLS best practices. This is done by creating an [update proposal](https://www.rfc-editor.org/rfc/rfc9420.html#name-update) to update your own leaf node. For more info on `Proposal` and `Commit` operations please refer to [MIP-03](03.md).

### KeyPackage Relays List Event

When using relay-based KeyPackage distribution, users publish a `kind: 10051` event to advertise which relays contain their KeyPackages. This helps others know where to look for your KeyPackages when they want to invite you to groups.

#### Requirements (for relay-based distribution)

- **Include relay tags**: List all relays where you publish KeyPackages
- **Make them accessible**: These relays SHOULD be readable by anyone you want to receive invites from
- **Keep updated**: Update this list when you change your relay setup

#### Example Relays List Event

```json
{
  "kind": 10051,
  "tags": [
    ["relay", "wss://inbox.nostr.wine"],
    ["relay", "wss://myrelay.nostr1.com"]
  ],
  "content": "",
  "created_at": 1693876543,
  "pubkey": "02a1633cafe37eeebe2b39b4ec5f3d74c35e61fa7e7e6b7b8c5f7c4f3b2a1b2c3d",
  "sig": "304502210..."
}
```

## Summary

This MIP defines the foundation of Marmot's identity system:

### Key Components

1. **MLS Credentials**: Link Nostr identities to MLS signing keys
2. **KeyPackages** (`kind: 443`): Advertise your ability to join groups (via relays or direct sharing)
3. **Relay Lists** (`kind: 10051`): Where to find your KeyPackages (for relay-based distribution)
4. **Signing Key Rotation**: Regular key updates for enhanced security

### Implementation Requirements

**MUST implement**:
- Credential management linking Nostr identities to MLS signing keys
- KeyPackage lifecycle management with last resort support
- Regular signing key rotation in all groups
- Immutable credential identity validation
