# MIP-01

## Group Construction & Nostr Group Data Extension

`draft` `mandatory`

This document defines how to create and configure MLS groups with Nostr integration, including the mandatory Nostr Group Data Extension. This is one of the core specifications that MUST be implemented by all projects wanting to be interoperable.

## Overview

Group construction in Marmot combines MLS's secure group primitives with Nostr's decentralized metadata system. This integration enables secure groups with verifiable admin controls, authenticated relay configurations, and encrypted media sharing.

## Creating Groups

### Group Identity and Privacy

Every MLS group has a unique 32-byte ID that serves as its permanent identifier. This ID is:
- **Private**: Never published to relays in any form
- **Permanent**: Cannot be changed once the group is created
- **Random**: Generated using secure randomness

### Compatibility Requirements

Before creating a group, clients must verify compatibility with intended members by checking their published `KeyPackage` events. This ensures all members support the same:
- **Ciphersuite**: Cryptographic algorithms used for the group
- **Capabilities**: MLS features the group will use
- **Extensions**: Additional functionality required by the group

### Required MLS Extensions

All groups MUST include these MLS extensions:

- [`required_capabilities`](https://docs.rs/openmls/latest/openmls/extensions/struct.RequiredCapabilitiesExtension.html) - Defines what MLS features all members must support
- [`ratchet_tree`](https://docs.rs/openmls/latest/openmls/extensions/struct.RatchetTreeExtension.html) - Manages the cryptographic key tree structure
- [`nostr_group_data`](#nostr-group-data-extension) - Links MLS groups to Nostr-specific data

### Group State Changes

Group modifications follow a two-step process:

1. **Proposal**: Any member can propose changes (add/remove members, update settings)
2. **Commit**: An admin commits to a set of proposals, making them official

While these are MLS operations, `Commit` events must be published to Nostr relays so all members can see and process the changes.

## Nostr Group Data Extension

The `nostr_group_data` extension bridges MLS groups with Nostr by securely linking Nostr-specific information to the MLS group state. This extension:

- **Is mandatory**: MUST be included in all groups
- **Is cryptographically secure**: Changes are authenticated and tamper-proof
- **Stores Nostr metadata**: Contains information like group admins and Nostr-specific settings

This extension MUST be included as a required capability when creating any new group.

### Extension Identifier

This extension uses the identifier `0xF2EE`. Implementations MUST use this identifier when registering support for this extension in MLS capabilities negotiation.

### Purpose and Use Cases

The Nostr Group Data Extension serves several critical functions:

1. **Group Identity Mapping**: Links MLS group encryption with Nostr's decentralized identity system
2. **Relay Agreement**: Provides authenticated relay endpoints for group message distribution
3. **Access Control**: Establishes cryptographically verified admin roles independent of MLS protocol roles
4. **Group Image Encryption**: Enables secure, encrypted media sharing within groups
5. **Metadata Protection**: Ensures group metadata changes are authenticated and verifiable by all members

### TLS Serialization Requirements

**CRITICAL IMPLEMENTATION NOTE**: This extension MUST be serialized using TLS presentation language as defined in [RFC 8446 Section 3](https://www.rfc-editor.org/rfc/rfc8446.html#section-3). All fields described below represent the logical structure - implementers MUST ensure their extension struct or object produces valid TLS wire format.

The extension data MUST be serializable as a TLS struct with proper length prefixes, type annotations, and byte alignment as required by the TLS presentation language specification. Failure to properly implement TLS serialization will result in interoperability failures between different MLS implementations.

### Extension Fields

The extension contains the following fields, each with specific validation requirements and constraints. When implementing TLS serialization, each field MUST be properly encoded according to its type specification.

#### Field Specifications

| Field            | TLS Type                                | Length Constraints | Description |
| ---------------- | --------------------------------------- | ------------------ | ----------- |
| `nostr_group_id` | `opaque nostr_group_id[32]`            | Exactly 32 bytes   | A 32-byte identifier for the group used in Nostr protocol operations. This value is distinct from the MLS group ID and MAY be updated over time through group proposals. This identifier is used in the `h` tags when publishing group message events to Nostr relays. MUST be cryptographically random when initially generated. |
| `name`           | `opaque name<0..2^16-1>`               | 0-65535 bytes      | UTF-8 encoded group name. MUST be valid UTF-8. SHOULD be limited to 255 characters for practical display purposes. Empty string is permitted for unnamed groups. |
| `description`    | `opaque description<0..2^16-1>`        | 0-65535 bytes      | UTF-8 encoded group description. MUST be valid UTF-8. SHOULD be limited to 1000 characters for practical display purposes. Empty string is permitted. |
| `admin_pubkeys`  | `opaque admin_pubkeys<0..2^16-1>`      | 0-65535 bytes      | Array of 32-byte Nostr public keys (hex-encoded as 64-character strings, then UTF-8 encoded). Each public key MUST be a valid secp256k1 public key. Clients MUST verify admin status before processing proposals that modify group state, membership, or metadata. The array MUST NOT contain duplicate keys. At least one admin key MUST be present for most group operations. |
| `relays`         | `opaque relays<0..2^16-1>`             | 0-65535 bytes      | Array of UTF-8 encoded WebSocket URLs for Nostr relays. Each URL MUST be a valid WebSocket URI (ws:// or wss://). URLs MUST be properly validated before use. The array SHOULD contain at least one relay URL and SHOULD NOT exceed 20 relays for practical performance. |
| `image_hash`     | `opaque image_hash[32]`                | Exactly 32 bytes   | SHA-256 hash identifying the group's display image stored via [Blossom](https://github.com/hzrd149/blossom/tree/master) protocol. The hash MUST correspond to the actual image content for integrity verification. May be all zeros if no image is set. |
| `image_key`      | `opaque image_key[32]`                 | Exactly 32 bytes   | AES-256-GCM encryption key for the group's image. MUST be cryptographically random. Used in conjunction with `image_nonce` for authenticated encryption. May be all zeros if no image encryption is needed. |
| `image_nonce`    | `opaque image_nonce[12]`               | Exactly 12 bytes   | AES-256-GCM nonce for image encryption. MUST be unique for each encrypted image. Used with `image_key` for authenticated encryption/decryption operations. May be all zeros if no image encryption is needed. |

#### TLS Structure Definition

In TLS presentation language, the extension data MUST be structured as:

```tls
struct {
    opaque nostr_group_id[32];
    opaque name<0..2^16-1>;
    opaque description<0..2^16-1>;
    opaque admin_pubkeys<0..2^16-1>;
    opaque relays<0..2^16-1>;
    opaque image_hash[32];
    opaque image_key[32];
    opaque image_nonce[12];
} NostrGroupData;
```

### Implementation Considerations

#### Array Encoding Specifications

**Admin Public Keys Array**:
The `admin_pubkeys` field contains a comma-separated list of hex-encoded public keys:
- Each public key: 64 hex characters (representing 32 bytes)
- Separator: single comma character (',')
- No spaces around commas
- Example: `"03a1b2c3d4e5f6...,02f6e5d4c3b2a1..."`

**Relays Array**:
The `relays` field contains a comma-separated list of WebSocket URLs:
- Each URL: valid WebSocket URI (ws:// or wss://)
- Separator: single comma character (',')
- No spaces around commas
- Example: `"wss://relay1.example.com,wss://relay2.example.com"`

#### Extension Lifecycle Management

**Creation**: When creating a new group, this extension MUST be populated with initial values and included in the group's required capabilities.

**Updates**: Any field in this extension can be updated through MLS Proposal/Commit mechanisms. However, certain operations require admin authorization:

- **Admin-Only Operations**: Modifying `admin_pubkeys`, `name`, `description`, `relays`, or image fields
- **Self-Service Operations**: None - all extension updates require admin approval
- **Validation**: Before processing any Commit that modifies this extension, implementations MUST verify the committer is listed in the current `admin_pubkeys` array

#### Interoperability Guidelines

**MLS Library Integration**:
1. Register extension with identifier `0xF2EE` in your MLS library
2. Implement proper TLS serialization/deserialization for the `NostrGroupData` struct
3. Ensure extension is marked as "required" in group capabilities
4. Hook into MLS proposal processing to validate admin permissions

**Cross-Implementation Compatibility**:
- Always use the exact TLS structure definition provided
- Validate all UTF-8 strings for proper encoding
- Reject malformed public keys or invalid URLs
- Implement consistent array parsing (comma-separated, no spaces)

**Error Handling**:
- Invalid TLS serialization MUST result in proposal rejection
- Malformed UTF-8 strings MUST be rejected
- Invalid public keys or URLs MUST be rejected
- Admin permission violations MUST be rejected

## Summary

This MIP defines the foundation for creating secure, Nostr-integrated groups:

### Key Components

1. **Group Creation**: Secure MLS group establishment with privacy protection
2. **Required Extensions**: Standard MLS extensions plus Nostr Group Data
3. **Nostr Group Data Extension**: Cryptographically secure bridge between MLS and Nostr
4. **Admin Controls**: Authenticated admin permissions for group management

### Security Requirements for Implementers

**MUST implement**:
- Required MLS extensions: `required_capabilities`, `ratchet_tree`, `nostr_group_data`
- Proper TLS serialization for Nostr Group Data Extension
- Admin verification for all extension updates
- Compatibility checking before group creation

**Security considerations**:
- Keep MLS group IDs private (never publish to relays)
- Validate all admin permissions before processing Commits
- Ensure proper TLS serialization for interoperability
- Verify all UTF-8 strings and public key formats
